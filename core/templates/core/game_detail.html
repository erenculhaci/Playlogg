{% extends 'base.html' %}

{% block title %}{{ game.name }} - Playlogg{% endblock %}

{% block content %}
<div class="min-h-screen py-8">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Game Header with Background Image -->
        <div class="relative mb-8 rounded-xl overflow-hidden">
            <!-- Background gradient overlay -->
            <div class="absolute inset-0 bg-gradient-to-r from-purple-900 to-indigo-900 opacity-90"></div>

            <!-- Game info content -->
            <div class="relative z-10 p-8 sm:p-12">
                <div class="flex flex-col md:flex-row items-start gap-8">
                    <!-- Game Image -->
                    <div class="md:w-1/3 flex-shrink-0">
                        <div class="relative rounded-lg overflow-hidden shadow-2xl group">
                            <div class="absolute inset-0 bg-gradient-to-t from-black to-transparent opacity-0 group-hover:opacity-60 transition-opacity duration-300"></div>
                            <img src="{{ game.image_url }}" alt="{{ game.name }}" class="w-full object-cover">

                            <!-- Like Overlay -->
                            <div class="absolute bottom-4 right-4">
                                <a href="{% url 'like_game' game.id %}" class="flex items-center justify-center w-12 h-12 rounded-full bg-black bg-opacity-60 hover:bg-opacity-80 transition-all duration-300 transform hover:scale-110">
                                    {% if user in game.liked_by.all %}
                                        <i class="fas fa-heart text-red-500 text-2xl"></i>
                                    {% else %}
                                        <i class="far fa-heart text-white text-2xl"></i>
                                    {% endif %}
                                </a>
                            </div>

                            <!-- Edit/Delete for owner -->
                            {% if game.added_by == user %}
                            <div class="absolute top-4 right-4 flex space-x-2">
                                <a href="{% url 'edit_game' game.id %}" class="flex items-center justify-center w-10 h-10 rounded-full bg-black bg-opacity-60 hover:bg-opacity-80 transition-all duration-300">
                                    <i class="fas fa-edit text-white"></i>
                                </a>
                                <a href="{% url 'delete_game' game.id %}" class="flex items-center justify-center w-10 h-10 rounded-full bg-black bg-opacity-60 hover:bg-opacity-80 transition-all duration-300" onclick="return confirm('Are you sure you want to delete this game?');">
                                    <i class="fas fa-trash-alt text-white"></i>
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Game Details -->
                    <div class="md:w-2/3">
                        <h1 class="text-4xl font-bold text-white mb-2">{{ game.name }}</h1>

                        <div class="flex flex-wrap items-center gap-4 text-sm text-gray-300 mb-4">
                            <div class="flex items-center">
                                <i class="fas fa-calendar-alt mr-2 text-purple-400"></i>
                                <span>Released: {{ game.release_date }}</span>
                            </div>

                            <div class="flex items-center">
                                <i class="fas fa-heart mr-2 text-red-400"></i>
                                <span>{{ game.liked_by.count }} favorites</span>
                            </div>

                            <div class="flex items-center">
                                <i class="fas fa-comment mr-2 text-blue-400"></i>
                                <span>{{ comments.count }} comments</span>
                            </div>

                            <div class="flex items-center">
                                <i class="fas fa-clipboard-list mr-2 text-green-400"></i>
                                <span>{{ logs_with_notes.count }} logs</span>
                            </div>
                        </div>

                        <!-- Game Description -->
                        <div class="bg-black bg-opacity-40 rounded-lg p-4 mb-4">
                            <!-- Short description (visible by default) -->
                            <div id="shortDescription" class="text-gray-200">
                                {{ game.description|truncatechars:300 }}
                                {% if game.description|length > 300 %}
                                    <button id="readMoreBtn" class="ml-2 text-purple-400 hover:text-purple-300 font-medium focus:outline-none">
                                        <i class="fas fa-angle-down mr-1"></i> Read more
                                    </button>
                                {% endif %}
                            </div>

                            <!-- Full description (hidden by default) -->
                            <div id="fullDescription" class="hidden text-gray-200">
                                {{ game.description }}
                                <button id="readLessBtn" class="ml-2 text-purple-400 hover:text-purple-300 font-medium focus:outline-none">
                                    <i class="fas fa-angle-up mr-1"></i> Read less
                                </button>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex flex-wrap gap-3 mt-6">
                            <a href="{% url 'add_log' game.id %}" class="inline-flex items-center px-5 py-2 bg-purple-600 border border-transparent rounded-md font-medium text-white hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 ease-in-out">
                                <i class="fas fa-plus mr-2"></i> Log Game
                            </a>

                            <a href="#comments" class="inline-flex items-center px-5 py-2 bg-blue-600 border border-transparent rounded-md font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                                <i class="fas fa-comment mr-2"></i> Comment
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs for Logs and Comments -->
        <div class="mb-8">
            <div class="border-b border-gray-700">
                <nav class="-mb-px flex space-x-8">
                    <a href="#logs" id="logsTab" class="border-purple-500 text-purple-400 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">
                        <i class="fas fa-clipboard-list mr-2"></i> Game Logs
                    </a>
                    <a href="#comments" id="commentsTab" class="border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">
                        <i class="fas fa-comments mr-2"></i> Comments
                    </a>
                </nav>
            </div>
        </div>

        <!-- Logs Section -->
        <div id="logsSection" class="bg-black bg-opacity-75 rounded-lg shadow-xl overflow-hidden mb-8">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-white">Player Logs</h2>

                    {% if user.is_authenticated %}
                    <a href="{% url 'add_log' game.id %}" class="inline-flex items-center px-4 py-2 bg-purple-600 border border-transparent rounded-md font-medium text-white hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 ease-in-out">
                        <i class="fas fa-plus mr-2"></i> Add Log
                    </a>
                    {% endif %}
                </div>

                {% if logs_with_notes %}
                <div class="space-y-6">
                    {% for log in logs_with_notes.all %}
                    <div class="bg-gray-800 rounded-lg shadow-md overflow-hidden transform transition-all duration-300 hover:shadow-xl hover:-translate-y-1">
                        <div class="flex flex-col md:flex-row">
                            <div class="md:w-1/6 bg-gray-900 p-4 flex flex-col items-center justify-center">
                                <a href="{% url 'view_profile' log.user.id %}" class="block text-center">
                                    <div class="w-16 h-16 mx-auto rounded-full overflow-hidden border-2 border-purple-500">
                                        <img src="{{ log.user.profile.profile_picture_url }}" alt="{{ log.user.username }}" class="w-full h-full object-cover">
                                    </div>
                                    <p class="text-purple-400 font-medium mt-2 hover:text-purple-300">{{ log.user.username }}</p>
                                </a>
                            </div>

                            <div class="p-4 flex-1">
                                <div class="flex flex-wrap items-center gap-3 mb-3">
                                    <!-- Status Badge -->
                                    <span class="px-3 py-1 rounded-full text-xs font-medium
                                                 {% if log.status == 'played' %}bg-green-800 text-green-200
                                                 {% elif log.status == 'abandoned' %}bg-red-800 text-red-200
                                                 {% elif log.status == 'shelved' %}bg-yellow-800 text-yellow-200
                                                 {% elif log.status == 'completed' %}bg-blue-800 text-blue-200
                                                 {% elif log.status == 'wishlist' %}bg-pink-800 text-pink-200
                                                 {% endif %}">
                                        <!-- Status Icon -->
                                        {% if log.status == 'played' %}
                                            <i class="fas fa-play-circle mr-1"></i> Played
                                        {% elif log.status == 'abandoned' %}
                                            <i class="fas fa-times-circle mr-1"></i> Abandoned
                                        {% elif log.status == 'shelved' %}
                                            <i class="fas fa-box mr-1"></i> Shelved
                                        {% elif log.status == 'completed' %}
                                            <i class="fas fa-check-circle mr-1"></i> Completed
                                        {% elif log.status == 'wishlist' %}
                                            <i class="fas fa-heart mr-1"></i> Wishlist
                                        {% endif %}
                                    </span>

                                    <span class="text-sm text-gray-400">
                                        <i class="fas fa-calendar-alt mr-1"></i> {{ log.created_at|date:"F j, Y" }}
                                    </span>
                                </div>

                                <!-- Game Info -->
                                <div class="flex flex-wrap gap-4 mb-3 text-sm text-gray-400">
                                    {% if log.hours_played %}
                                    <div class="flex items-center">
                                        <i class="fas fa-clock mr-1"></i>
                                        {{ log.hours_played }} hours
                                    </div>
                                    {% endif %}

                                    {% if log.rating %}
                                    <div class="flex items-center">
                                        <i class="fas fa-star mr-1 text-yellow-500"></i>
                                        {{ log.rating }}/5
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Notes -->
                                {% if log.notes %}
                                <div class="mt-3 p-3 bg-gray-900 rounded-lg text-gray-300">
                                    <p>{{ log.notes }}</p>
                                </div>
                                {% endif %}

                                <!-- Actions -->
                                {% if log.user == request.user %}
                                <div class="mt-4 flex space-x-4">
                                    <a href="{% url 'edit_log' log.id %}" class="text-blue-400 hover:text-blue-300 transition duration-150">
                                        <i class="fas fa-edit mr-1"></i> Edit
                                    </a>
                                    <form action="{% url 'delete_log' log.id %}" method="post" onsubmit="return confirm('Are you sure you want to delete this log?');" class="inline">
                                        {% csrf_token %}
                                        <button type="submit" class="text-red-400 hover:text-red-300 transition duration-150">
                                            <i class="fas fa-trash mr-1"></i> Delete
                                        </button>
                                    </form>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-12">
                    <div class="inline-block p-6 rounded-full bg-gray-800 mb-4">
                        <i class="fas fa-clipboard-list text-4xl text-purple-500"></i>
                    </div>
                    <p class="text-gray-400 text-lg">No logs yet for this game</p>
                    <p class="text-gray-500 mt-2">Be the first to add your gaming experience!</p>

                    {% if user.is_authenticated %}
                    <a href="{% url 'add_log' game.id %}" class="inline-flex items-center px-4 py-2 mt-4 bg-purple-600 border border-transparent rounded-md font-medium text-white hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 ease-in-out">
                        <i class="fas fa-plus mr-2"></i> Add Log
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Comments Section -->
        <div id="commentsSection" class="hidden bg-black bg-opacity-75 rounded-lg shadow-xl overflow-hidden mb-8">
            <div class="p-6">
                <h2 class="text-2xl font-semibold text-white mb-6">Comments & Discussion</h2>

                <!-- Add Comment Form -->
                {% if user.is_authenticated %}
                <div class="mb-8 bg-gray-800 rounded-lg p-4">
                    <h3 class="text-lg font-medium text-white mb-3">Leave a Comment</h3>
                    <form action="{% url 'add_comment' game.id %}" method="post">
                        {% csrf_token %}
                        <textarea name="comment" class="w-full p-3 border border-gray-600 rounded-lg text-white bg-transparent focus:ring-2 focus:ring-purple-500 placeholder-gray-400" placeholder="Write your comment here..."></textarea>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg mt-4 hover:bg-blue-600 transform transition-all hover:scale-105">
                            <i class="fas fa-paper-plane mr-2"></i> Post Comment
                        </button>
                    </form>
                </div>
                {% endif %}

                <!-- Display Comments -->
                {% if comments %}
                <div class="space-y-6">
                    {% for comment in comments %}
                    <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                        <div class="flex justify-between items-center">
                            <a href="{% url 'view_profile' comment.user.id %}" class="text-purple-400 font-medium hover:text-purple-300">
                                {{ comment.user.username }}
                            </a>
                            <span class="text-sm text-gray-400">{{ comment.created_at|date:"F j, Y, H:i" }}</span>
                        </div>
                        <p class="text-gray-300 mt-2">{{ comment.text }}</p>

                        <!-- Like and Reply buttons -->
                        <div class="flex items-center space-x-4 mt-3">
                            <a href="{% url 'like_comment' comment.id %}" class="text-blue-400 hover:text-blue-300">
                                <i class="fas fa-thumbs-up"></i> {{ comment.likes.count }}
                            </a>
                            <button onclick="toggleReplyForm({{ comment.id }})" class="text-gray-400 hover:text-gray-300">
                                <i class="fas fa-reply"></i> Reply
                            </button>
                        </div>

                        <!-- Reply Form -->
                        <div id="replyForm-{{ comment.id }}" class="hidden mt-3">
                            <form action="{% url 'add_comment' game.id %}" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                <textarea name="comment" class="w-full p-2 border border-gray-600 rounded-lg text-white bg-transparent focus:ring-2 focus:ring-purple-500 placeholder-gray-400" placeholder="Write your reply..."></textarea>
                                <button type="submit" class="bg-gray-500 text-white px-3 py-1 rounded-lg mt-2 hover:bg-gray-600 transform transition-all hover:scale-105">
                                    Reply
                                </button>
                            </form>
                        </div>

                        <!-- Display Replies -->
                        {% for reply in comment.replies.all %}
                        <div class="ml-6 mt-2 border-l-2 border-gray-700 pl-4">
                            <a href="{% url 'view_profile' reply.user.id %}" class="text-purple-400 font-medium hover:text-purple-300">
                                {{ reply.user.username }}
                            </a>
                            <span class="text-sm text-gray-400">{{ reply.created_at|date:"F j, Y, H:i" }}</span>
                            <p class="text-gray-300 mt-1">{{ reply.text }}</p>
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-white text-center mt-4">No comments yet. Be the first to start the discussion!</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Read More, Read Less, and Reply Toggle -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const readMoreBtn = document.getElementById('readMoreBtn');
        const readLessBtn = document.getElementById('readLessBtn');
        const shortDescription = document.getElementById('shortDescription');
        const fullDescription = document.getElementById('fullDescription');

        if (readMoreBtn) {
            readMoreBtn.addEventListener('click', function() {
                shortDescription.classList.add('hidden');
                fullDescription.classList.remove('hidden');
            });
        }

        if (readLessBtn) {
            readLessBtn.addEventListener('click', function() {
                fullDescription.classList.add('hidden');
                shortDescription.classList.remove('hidden');
            });
        }
    });

    function toggleReplyForm(commentId) {
        const replyForm = document.getElementById(`replyForm-${commentId}`);
        if (replyForm) {
            replyForm.classList.toggle('hidden');
        }
    }
</script>

{% endblock %}
